@model List<Etutlist.Models.TaburTelafiAyarlari>

@{
    ViewData["Title"] = "Tabur Telafi Ayarları";
    var gunler = new[] { "Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma" };
}

<div class="container-fluid mt-3">
    <h2><i class="bi bi-gear-fill"></i> Tabur Telafi Ayarları</h2>

    <div class="mb-3">
        <a asp-action="Index" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Geri
        </a>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTaburModal">
            <i class="bi bi-plus-circle"></i> Yeni Tabur Ekle
        </button>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Bilgilendirme -->
    <div class="alert alert-info">
        <h5><i class="bi bi-info-circle-fill"></i> Nasıl Kullanılır?</h5>
        <ol class="mb-0">
            <li><strong>Yeni Tabur Ekle:</strong> Fakülte, tabur adı ve kısım aralığını belirleyin</li>
            <li><strong>Telafi Ayarları:</strong> Tabur seçtikten sonra 5 iş günü için ayrı ayrı ayar yapın</li>
            <li><strong>Her Gün İçin:</strong> Başlama saati seçin veya "Bu gün telafi yapılmaz" işaretleyin</li>
        </ol>
    </div>

    <!-- Taburlar ve Telafi Ayarları -->
    @if (ViewBag.Taburlar != null && ((List<Etutlist.Models.Tabur>)ViewBag.Taburlar).Any())
    {
        foreach (var tabur in (List<Etutlist.Models.Tabur>)ViewBag.Taburlar)
        {
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="bi bi-building"></i> @tabur.TaburAdi - @tabur.Fakulte.Ad
                            <small class="ms-2">(Kısım @tabur.MinKisimNo-@tabur.MaxKisimNo)</small>
                        </h5>
                    </div>
                    <div>
                        <form asp-action="TaburSil" method="post" style="display:inline;"
                              onsubmit="return confirm('Bu taburu silmek istediğinize emin misiniz?');">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@tabur.Id" />
                            <button type="submit" class="btn btn-sm btn-danger">
                                <i class="bi bi-trash-fill"></i> Taburu Sil
                            </button>
                        </form>
                    </div>
                </div>
                <div class="card-body">
                    <form asp-action="TelafiAyarlariKaydet" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="TaburId" value="@tabur.Id" />
                        
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 150px;">Gün</th>
                                        <th style="width: 200px;">Başlama Saati</th>
                                        <th>Atlanacak Saatler (Checkbox)</th>
                                        <th style="width: 150px;">Bu Gün Telafi Yapılmaz</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (int i = 0; i < gunler.Length; i++)
                                    {
                                        var gun = gunler[i];
                                        var mevcutAyar = Model.FirstOrDefault(a => a.TaburId == tabur.Id && a.TelafiYapilacakGun == gun);
                                        var ayarId = mevcutAyar?.Id ?? 0;
                                        var baslamaSaati = mevcutAyar?.TelafiBaslamaSaati ?? 7;
                                        var atlanacakSaatler = mevcutAyar?.TelafiYapilamayacakDersSaatleri ?? "";
                                        var telafiYapilmaz = mevcutAyar != null && mevcutAyar.TelafiBaslamaSaati == 0;
                                        
                                        <tr>
                                            <td class="align-middle">
                                                <strong>@gun</strong>
                                                <input type="hidden" name="Gunler[@i].Gun" value="@gun" />
                                                <input type="hidden" name="Gunler[@i].AyarId" value="@ayarId" />
                                            </td>
                                            <td>
                                                <select name="Gunler[@i].BaslamaSaati" class="form-select baslama-saati" data-gun="@gun" @(telafiYapilmaz ? "disabled" : "")>
                                                    @for (int saat = 1; saat <= 9; saat++)
                                                    {
                                                        <option value="@saat" selected="@(baslamaSaati == saat)">@saat. Ders</option>
                                                    }
                                                </select>
                                            </td>
                                            <td>
                                                <div class="d-flex flex-wrap gap-2">
                                                    @for (int saat = 1; saat <= 9; saat++)
                                                    {
                                                        var isChecked = !string.IsNullOrEmpty(atlanacakSaatler) && atlanacakSaatler.Split(',').Contains(saat.ToString());
                                                        <div class="form-check form-check-inline">
                                                            <input class="form-check-input atlanacak-saat-@gun" 
                                                                   type="checkbox" 
                                                                   value="@saat" 
                                                                   id="@gun-saat@saat"
                                                                   @(isChecked ? "checked" : "")
                                                                   @(telafiYapilmaz ? "disabled" : "")>
                                                            <label class="form-check-label" for="@gun-saat@saat">@saat</label>
                                                        </div>
                                                    }
                                                </div>
                                                <input type="hidden" name="Gunler[@i].AtlanacakSaatler" class="atlanacak-saatler-input" data-gun="@gun" value="@atlanacakSaatler" />
                                            </td>
                                            <td class="text-center align-middle">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input telafi-yapilmaz-switch" 
                                                           type="checkbox" 
                                                           name="Gunler[@i].TelafiYapilmaz" 
                                                           data-gun="@gun"
                                                           @(telafiYapilmaz ? "checked" : "")
                                                           value="true">
                                                    <label class="form-check-label">Yapılmaz</label>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-check-circle"></i> Ayarları Kaydet
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        }
    }
    else
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> Henüz tabur eklenmemiş. "Yeni Tabur Ekle" butonuna tıklayın.
        </div>
    }
</div>

<!-- Tabur Ekleme Modalı -->
<div class="modal fade" id="addTaburModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="TaburEkle" method="post" id="addTaburForm">
                @Html.AntiForgeryToken()
                
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Yeni Tabur Ekle</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Fakülte <span class="text-danger">*</span></label>
                        <select name="FakulteId" class="form-select" required>
                            <option value="">-- Fakülte Seçin --</option>
                            @if (ViewBag.Fakulteler != null)
                            {
                                foreach (var fakulte in ViewBag.Fakulteler)
                                {
                                    <option value="@fakulte.Id">@fakulte.Ad</option>
                                }
                            }
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Tabur Adı <span class="text-danger">*</span></label>
                        <input type="text" name="TaburAdi" class="form-control" 
                               placeholder="Örn: 1. Tabur, 2. Tabur" required />
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Min Kısım No <span class="text-danger">*</span></label>
                                <input type="number" name="MinKisimNo" class="form-control" 
                                       min="1" max="99" placeholder="1" required />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Max Kısım No <span class="text-danger">*</span></label>
                                <input type="number" name="MaxKisimNo" class="form-control" 
                                       min="1" max="99" placeholder="16" required />
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Tabur Ekle
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const gunler = @Html.Raw(Json.Serialize(gunler));
            
            gunler.forEach(gun => {
                const checkboxes = document.querySelectorAll(`.atlanacak-saat-${gun}`);
                const hiddenInput = document.querySelector(`.atlanacak-saatler-input[data-gun="${gun}"]`);
                
                checkboxes.forEach(cb => {
                    cb.addEventListener('change', function() {
                        const seciliSaatler = Array.from(checkboxes)
                            .filter(c => c.checked)
                            .map(c => c.value)
                            .sort((a, b) => parseInt(a) - parseInt(b))
                            .join(',');
                        hiddenInput.value = seciliSaatler;
                    });
                });
                
                const telafiSwitch = document.querySelector(`.telafi-yapilmaz-switch[data-gun="${gun}"]`);
                const baslamaSaatiSelect = document.querySelector(`.baslama-saati[data-gun="${gun}"]`);
                
                if (telafiSwitch && baslamaSaatiSelect) {
                    telafiSwitch.addEventListener('change', function() {
                        const yapilmaz = telafiSwitch.checked;
                        baslamaSaatiSelect.disabled = yapilmaz;
                        checkboxes.forEach(cb => cb.disabled = yapilmaz);
                        
                        if (yapilmaz) {
                            baslamaSaatiSelect.value = '0';
                            checkboxes.forEach(cb => cb.checked = false);
                            hiddenInput.value = '';
                        } else {
                            baslamaSaatiSelect.value = '7';
                        }
                    });
                }
            });

            const addTaburForm = document.getElementById('addTaburForm');
            if (addTaburForm) {
                addTaburForm.addEventListener('submit', function(e) {
                    const minKisim = parseInt(document.querySelector('input[name="MinKisimNo"]').value);
                    const maxKisim = parseInt(document.querySelector('input[name="MaxKisimNo"]').value);
                    
                    if (minKisim > maxKisim) {
                        e.preventDefault();
                        alert('Min Kısım No, Max Kısım No\'dan büyük olamaz!');
                        return false;
                    }
                });
            }
        });
    </script>
}

