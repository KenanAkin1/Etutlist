@{
ViewData["Title"] = "Ýkame / Birleþtirme Ekle";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
   <div class="d-flex justify-content-between align-items-center mb-4">
  <h2><i class="bi bi-arrow-repeat"></i> Ýkame / Birleþtirme Ekle</h2>
    <a asp-action="Index" class="btn btn-secondary">
     <i class="bi bi-arrow-left"></i> Geri
              </a>
            </div>

     @if (TempData["Error"] != null)
       {
            <div class="alert alert-danger alert-dismissible fade show">
             <i class="bi bi-exclamation-triangle"></i> @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

 <div class="alert alert-info">
        <h5><i class="bi bi-info-circle"></i> Nasýl Çalýþýr?</h5>
       <ul class="mb-0">
          <li>? <strong>Blok seçimi:</strong> Tüm saatleri seçmek için ana bloða týklayýn</li>
           <li>? <strong>Tek tek seçim:</strong> Sadece belirli saatleri seçmek için alt butonlarý kullanýn</li>
      <li>?? Sistem otomatik olarak Ýkame veya Birleþtirme tipini belirleyecektir</li>
                </ul>
 </div>

            <form asp-action="CreateIkame" method="post" id="ikameForm">
    @Html.AntiForgeryToken()
       <input type="hidden" name="TelafiTarihi" id="telafiTarihiHidden" />

                <div class="card mb-4">
             <div class="card-header bg-primary text-white">
     <h5><i class="bi bi-1-circle"></i> Fakülte Seçin</h5>
       </div>
    <div class="card-body">
   <select name="FakulteId" id="fakulteSelect" class="form-select" required>
            <option value="">-- Fakülte Seçiniz --</option>
        @foreach (var fakulte in ViewBag.Fakulteler as SelectList)
      {
       <option value="@fakulte.Value">@fakulte.Text</option>
       }
      </select>
     </div>
     </div>

     <div class="card mb-4" id="dersCard" style="display:none;">
  <div class="card-header bg-success text-white">
   <h5><i class="bi bi-2-circle"></i> Ders ve Hoca Bilgileri</h5>
         </div>
       <div class="card-body">
       <div class="row g-3">
       <div class="col-md-4">
      <label class="form-label"><strong>Ders Adý</strong> <span class="text-danger">*</span></label>
<input type="text" name="DersAdi" id="dersAdiInput" class="form-control" 
         placeholder="Örn: Kriminoloji" required autocomplete="off" />
    <div id="dersOneri" class="list-group mt-1" style="position: absolute; z-index: 1000; width: 30%;"></div>
              </div>
           <div class="col-md-4">
              <label class="form-label"><strong>Asýl Hoca</strong> <span class="text-danger">*</span></label>
          <input type="text" id="asilHocaInput" class="form-control" 
      placeholder="Hoca adý" required autocomplete="off" />
       <input type="hidden" name="AsilHocaId" id="asilHocaId" />
  <div id="asilHocaOneri" class="list-group mt-1" style="position: absolute; z-index: 1000; width: 30%;"></div>
             </div>
      <div class="col-md-4">
     <label class="form-label"><strong>Kýsým No</strong> <span class="text-danger">*</span></label>
     <input type="number" name="KisimNo" id="kisimNoInput" class="form-control" 
      placeholder="1, 2, 3..." min="1" required />
  </div>
          </div>
  </div>
  </div>

        <div class="card mb-4" id="dersSaatCard" style="display:none;">
       <div class="card-header bg-info text-white">
   <h5><i class="bi bi-3-circle"></i> Hangi Ders Saatleri? (Blok veya Tek Seçim)</h5>
   </div>
     <div class="card-body">
 <div id="dersSaatSecenekleri"></div>
     <div id="dersSaatLoading" class="text-center py-3" style="display:none;">
           <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-2">Ders saatleri getiriliyor...</p>
          </div>
        <div id="dersSaatYok" class="alert alert-warning" style="display:none;">
   <i class="bi bi-exclamation-triangle"></i> Bu kýsým için ders saati bulunamadý.
                </div>
       </div>
    </div>

  <div class="card mb-4" id="yedekHocaCard" style="display:none;">
                <div class="card-header bg-warning text-dark">
 <h5><i class="bi bi-4-circle"></i> Yerine Girecek Hoca</h5>
  </div>
    <div class="card-body">
         <input type="text" id="yedekHocaInput" class="form-control" 
          placeholder="Yerine girecek hoca" required autocomplete="off" />
       <input type="hidden" name="YedekHocaId" id="yedekHocaId" />
     <div id="yedekHocaOneri" class="list-group mt-1" style="position: absolute; z-index: 1000; width: 50%;"></div>
        </div>
  </div>

           <div class="card mb-4" id="detayCard" style="display:none;">
      <div class="card-header bg-secondary text-white">
  <h5><i class="bi bi-5-circle"></i> Tarih ve Ek Bilgiler</h5>
        </div>
          <div class="card-body">
        <div class="row g-3 mb-3">
    <div class="col-md-12">
        <label class="form-label"><strong>Ýkame/Birleþtirme Tarihi</strong> <span class="text-danger">*</span></label>
          <input type="date" id="telafiTarihiInput" class="form-control" required />
       <small class="text-muted" id="tarihAciklama">Otomatik hesaplanan tarih</small>
      </div>
            </div>
             <div class="row g-3">
         <div class="col-md-6">
   <label class="form-label"><strong>Neden</strong> <span class="text-danger">*</span></label>
   <input type="text" name="TelafiNedeni" class="form-control" 
       placeholder="Örn: Ýzin, Hastalýk, Görev..." required />
        </div>
      <div class="col-md-6">
             <label class="form-label"><strong>Açýklama</strong></label>
        <textarea name="Aciklama" class="form-control" rows="3" placeholder="Ek açýklama (opsiyonel)"></textarea>
       </div>
   </div>
       </div>
              </div>

      <div class="d-grid gap-2 d-md-flex justify-content-md-end">
         <a asp-action="Index" class="btn btn-secondary">
        <i class="bi bi-x-circle"></i> Ýptal
                    </a>
           <button type="submit" class="btn btn-primary btn-lg">
       <i class="bi bi-save"></i> Kaydet
         </button>
    </div>
      </form>
  </div>
    </div>
</div>

@section Scripts {
<script>
let fakulteId = 0;
let secilenGun = '';
let secilenSaatler = [];

$('#fakulteSelect').change(function() {
    fakulteId = $(this).val();
    if (fakulteId) {
        $('#dersCard, #yedekHocaCard, #detayCard').show();
    }
});

$('#dersAdiInput').on('input', function() {
    let term = $(this).val();
    if (term.length < 2) {
        $('#dersOneri').empty();
        return;
    }
    $.ajax({
        url: '@Url.Action("SearchDersler", "DersProgrami")',
        data: { term: term },
        success: function(data) {
   let html = '';
            data.forEach(d => {
     html += `<a href="#" class="list-group-item list-group-item-action" onclick="dersSecildi('${d.dersAdi}'); return false;">${d.dersAdi}</a>`;
     });
            $('#dersOneri').html(html);
      }
    });
});

function dersSecildi(ad) {
    $('#dersAdiInput').val(ad);
    $('#dersOneri').empty();
}

$('#asilHocaInput, #yedekHocaInput').on('input', function() {
    let term = $(this).val();
let targetDiv = $(this).attr('id') === 'asilHocaInput' ? '#asilHocaOneri' : '#yedekHocaOneri';
    
    if (term.length < 2 || !fakulteId) {
   $(targetDiv).empty();
        return;
    }

    $.ajax({
        url: '@Url.Action("SearchHocalar", "DersProgrami")',
        data: { fakulteId: fakulteId, term: term },
  success: function(data) {
       let html = '';
  data.forEach(h => {
       let inputId = targetDiv === '#asilHocaOneri' ? 'asilHocaInput' : 'yedekHocaInput';
    let hiddenId = targetDiv === '#asilHocaOneri' ? 'asilHocaId' : 'yedekHocaId';
      html += `<a href="#" class="list-group-item list-group-item-action" onclick="hocaSecildi('${h.adSoyad}', ${h.id}, '${inputId}', '${hiddenId}'); return false;">${h.rutbe} ${h.adSoyad}</a>`;
    });
  $(targetDiv).html(html);
      }
    });
});

function hocaSecildi(ad, id, inputId, hiddenId) {
    $('#' + inputId).val(ad);
    $('#' + hiddenId).val(id);
    $('#' + inputId).next().next('.list-group').empty();
    
    if (inputId === 'asilHocaInput') {
        kisimSecildi();
    }
}

$('#kisimNoInput').change(function() {
    kisimSecildi();
});

function kisimSecildi() {
    let hocaId = $('#asilHocaId').val();
    let kisimNo = $('#kisimNoInput').val();

    if (!fakulteId || !hocaId || !kisimNo) return;

    $('#dersSaatLoading').show();
  $('#dersSaatSecenekleri').empty();
    $('#dersSaatYok').hide();
    $('#dersSaatCard').show();

    $.ajax({
        url: '@Url.Action("GetDersSaatleri", "TelafiDers")',
        data: { fakulteId: fakulteId, hocaId: hocaId, kisimNo: kisimNo },
        success: function(data) {
       $('#dersSaatLoading').hide();
  
          if (data.length === 0) {
    $('#dersSaatYok').show();
          return;
            }

    let html = '';
      data.forEach((item, blokIndex) => {
        let gunBadge = getGunBadge(item.gun);
   
           html += `<div class="card mb-3 border-primary">
      <div class="card-header bg-light">
         <div class="form-check">
                 <input class="form-check-input blok-checkbox" type="checkbox" 
              id="blok${blokIndex}" data-blok="${blokIndex}" 
  data-gun="${item.gun}" 
           data-saatler='${JSON.stringify(item.saatler)}'>
          <label class="form-check-label fw-bold" for="blok${blokIndex}">
<span class="${gunBadge} me-2">${item.gun}</span>
        <strong>TÜMÜ (${item.saatler.join('-')}. Saatler)</strong>
   </label>
                   </div>
        </div>
        <div class="card-body">
      <div class="d-flex flex-wrap gap-2">`;
     
                item.saatler.forEach(saat => {
      html += `<div class="form-check form-check-inline">
            <input class="form-check-input saat-checkbox" type="checkbox" 
      id="saat_${blokIndex}_${saat}" 
    data-blok="${blokIndex}" 
                 data-gun="${item.gun}" 
  data-saat="${saat}">
    <label class="form-check-label" for="saat_${blokIndex}_${saat}">
     ${saat}. Saat
    </label>
     </div>`;
    });

          html += `</div></div></div>`;
   });

        $('#dersSaatSecenekleri').html(html);

            $('.blok-checkbox').change(function() {
     let blokIndex = $(this).data('blok');
     let isChecked = $(this).is(':checked');
   
           $('.blok-checkbox').not(this).prop('checked', false);
          $('.saat-checkbox').prop('checked', false);
  
         if (isChecked) {
               $(`.saat-checkbox[data-blok="${blokIndex}"]`).prop('checked', true);
                secilenGun = $(this).data('gun');
               secilenSaatler = $(this).data('saatler');
         hesaplaTarih(secilenGun);
            }
            });

 $('.saat-checkbox').change(function() {
let blokIndex = $(this).data('blok');
 
             let secilenler = [];
        $(`.saat-checkbox[data-blok="${blokIndex}"]:checked`).each(function() {
          secilenler.push($(this).data('saat'));
                });

       if (secilenler.length > 0) {
     $('.blok-checkbox').not(`#blok${blokIndex}`).prop('checked', false);
           $(`.saat-checkbox:not([data-blok="${blokIndex}"])`).prop('checked', false);
    
       secilenGun = $(this).data('gun');
                secilenSaatler = secilenler.sort((a, b) => a - b);
        
         let toplamSaat = $(`.saat-checkbox[data-blok="${blokIndex}"]`).length;
     if (secilenler.length === toplamSaat) {
  $(`#blok${blokIndex}`).prop('checked', true);
        } else {
  $(`#blok${blokIndex}`).prop('checked', false);
      }
         
  hesaplaTarih(secilenGun);
    } else {
 $(`#blok${blokIndex}`).prop('checked', false);
     }
  });
        }
    });
}

function hesaplaTarih(gun) {
    let bugun = new Date();
    let bugunGunNo = bugun.getDay();
    
    let gunMap = {
        'Pazartesi': 1,
        'Salý': 2,
   'Çarþamba': 3,
        'Perþembe': 4,
        'Cuma': 5
    };
    
    let hedefGunNo = gunMap[gun];
    let fark = hedefGunNo - bugunGunNo;
    
    if (bugunGunNo === 0) {
        fark = hedefGunNo === 1 ? 1 : hedefGunNo;
    } else if (bugunGunNo === 6) {
        fark = (7 - bugunGunNo) + hedefGunNo;
    } else {
        if (fark <= 0) fark += 7;
    }
  
    let hedefTarih = new Date();
    hedefTarih.setDate(bugun.getDate() + fark);
  
    let tarihStr = hedefTarih.toISOString().split('T')[0];
    $('#telafiTarihiInput').val(tarihStr);
    $('#telafiTarihiHidden').val(tarihStr);
  
    $('#telafiTarihiInput').off('change').on('change', function() {
        $('#telafiTarihiHidden').val($(this).val());
    });
    
    let gunAdi = ['Pazar', 'Pazartesi', 'Salý', 'Çarþamba', 'Perþembe', 'Cuma', 'Cumartesi'][hedefTarih.getDay()];
    $('#tarihAciklama').text(`${gunAdi}, ${hedefTarih.toLocaleDateString('tr-TR')} - Deðiþtirebilirsiniz`);
}

function getGunBadge(gun) {
    switch(gun) {
   case 'Pazartesi': return 'badge bg-primary';
        case 'Salý': return 'badge bg-success';
    case 'Çarþamba': return 'badge bg-info';
        case 'Perþembe': return 'badge bg-warning text-dark';
        case 'Cuma': return 'badge bg-danger';
      default: return 'badge bg-secondary';
    }
}

$('#ikameForm').on('submit', function(e) {
    if (!secilenGun || secilenSaatler.length === 0) {
        e.preventDefault();
        alert('Lütfen ders saati seçin!');
        return false;
    }
    
    $(this).append(`<input type="hidden" name="DersGunu" value="${secilenGun}" />`);
    $(this).append(`<input type="hidden" name="DersSaati" value="${secilenSaatler[0]}" />`);
  $(this).append(`<input type="hidden" name="KacSaat" value="${secilenSaatler.length}" />`);
});
</script>
}
