@{
    ViewData["Title"] = "Telafi Ekle";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
   <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="bi bi-calendar-plus"></i> Telafi Dersi Ekle</h2>
   <a asp-action="Index" class="btn btn-secondary">
  <i class="bi bi-arrow-left"></i> Geri
     </a>
         </div>

     @if (TempData["Error"] != null)
 {
         <div class="alert alert-danger alert-dismissible fade show">
  <i class="bi bi-exclamation-triangle"></i> @TempData["Error"]
   <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
 </div>
   }

     <!-- AÇIKLAMA -->
 <div class="alert alert-success">
             <h5><i class="bi bi-info-circle"></i> Telafi Nedir?</h5>
     <p class="mb-0"><strong>Telafi:</strong> Ayný hoca, dersi farklý bir tarih ve saatte yapýyor. Birden fazla kýsým için tek seferde telafi ekleyebilirsiniz (Örn: 1-2-3).</p>
  </div>

   <!-- FORM -->
        <form asp-action="CreateTelafi" method="post" id="telafiForm">
  @Html.AntiForgeryToken()

     <!-- 1. ADIM: FAKÜLTE -->
      <div class="card mb-4">
              <div class="card-header bg-primary text-white">
       <h5><i class="bi bi-1-circle"></i> Fakülte Seçin</h5>
    </div>
 <div class="card-body">
       <select name="fakulteId" id="fakulteSelect" class="form-select" required>
           <option value="">-- Fakülte Seçiniz --</option>
       @foreach (var fakulte in ViewBag.Fakulteler as SelectList)
      {
  <option value="@fakulte.Value">@fakulte.Text</option>
   }
     </select>
   </div>
        </div>

  <!-- 2. ADIM: DERS & HOCA -->
   <div class="card mb-4" id="dersHocaCard" style="display:none;">
   <div class="card-header bg-success text-white">
    <h5><i class="bi bi-2-circle"></i> Ders ve Hoca Bilgisi</h5>
     </div>
       <div class="card-body">
  <div class="row g-3">
          <div class="col-md-6">
       <label class="form-label"><strong>Ders</strong> <span class="text-danger">*</span></label>
    <input type="text" id="dersInput" class="form-control" placeholder="Ders adý yazýn..." autocomplete="off" required />
         <input type="hidden" name="dersId" id="dersId" />
       <div id="dersOneri" class="list-group mt-1" style="position: absolute; z-index: 1000; max-width: 45%;"></div>
          </div>
       <div class="col-md-6">
<label class="form-label"><strong>Hoca</strong> <span class="text-danger">*</span></label>
        <input type="text" id="hocaInput" class="form-control" placeholder="Hoca adý yazýn..." autocomplete="off" required />
<input type="hidden" name="hocaId" id="hocaId" />
          <div id="hocaOneri" class="list-group mt-1" style="position: absolute; z-index: 1000; max-width: 45%;"></div>
       </div>
    </div>
           </div>
       </div>

       <!-- 3. ADIM: KISIM -->
             <div class="card mb-4" id="kisimCard" style="display:none;">
  <div class="card-header bg-info text-white">
  <h5><i class="bi bi-3-circle"></i> Kýsým Seçimi</h5>
     </div>
            <div class="card-body">
            <div class="row g-3">
    <div class="col-md-6">
     <label class="form-label"><strong>Kýsým No(larý)</strong> <span class="text-danger">*</span></label>
     <input type="text" name="kisimlar" id="kisimInput" class="form-control" placeholder="Örn: 1-2-3" required />
      <small class="text-muted">Birden fazla kýsým için tire ile ayýrýn: 1-2-3-4</small>
  </div>
     <div class="col-md-6">
<label class="form-label"><strong>Saatleri Getir</strong></label>
          <button type="button" class="btn btn-primary w-100" id="saatleriGetirBtn">
         <i class="bi bi-search"></i> Ders Saatlerini Getir
             </button>
   </div>
      </div>

     <!-- DERS SAATLERÝ GÖSTERÝM -->
      <div id="saatlerDiv" class="mt-3" style="display:none;">
<label class="form-label"><strong>Normal Ders Günü ve Saati</strong> <span class="text-danger">*</span></label>
  <div id="saatListesi" class="d-flex flex-wrap gap-2"></div>
       <input type="hidden" name="normalGun" id="normalGunInput" />
         <input type="hidden" name="normalDersSaati" id="normalSaatInput" />
   </div>
      </div>
  </div>

  <!-- 4. ADIM: TELAFÝ TARÝHÝ VE SAATÝ -->
      <div class="card mb-4" id="telafiSaatCard" style="display:none;">
      <div class="card-header bg-warning text-dark">
      <h5><i class="bi bi-4-circle"></i> Telafi Tarihi ve Saati</h5>
     </div>
    <div class="card-body">
     <div class="row g-3 mb-3">
     <div class="col-md-12">
     <label class="form-label"><strong>Telafi Tarihi</strong> <span class="text-danger">*</span></label>
        <input type="date" name="telafiTarihi" class="form-control" required />
    </div>
     </div>

          <!-- BAÞLANGIÇ SAAT -->
       <div class="row g-3">
       <div class="col-md-6">
     <label class="form-label"><strong>Baþlangýç Saati</strong> <span class="text-danger">*</span></label>
        <select name="baslangicSaat" id="baslangicSaatSelect" class="form-select" required>
     <option value="">Seçiniz</option>
        <option value="1">1. DERS (09:00-09:40)</option>
            <option value="2">2. DERS (09:50-10:30)</option>
      <option value="3">3. DERS (10:40-11:20)</option>
         <option value="4">4. DERS (11:30-12:10)</option>
                 <option value="5">5. DERS (13:00-13:40)</option>
       <option value="6">6. DERS (13:50-14:30)</option>
<option value="7">7. DERS (14:40-15:20)</option>
      <option value="8">8. DERS (15:30-16:10)</option>
       </select>
      </div>
      <div class="col-md-6">
    <label class="form-label"><strong>Bitiþ Saati</strong> <span class="text-danger">*</span></label>
   <select name="bitisSaat" id="bitisSaatSelect" class="form-select" required>
       <option value="">Seçiniz</option>
      <option value="1">1. DERS (09:00-09:40)</option>
    <option value="2">2. DERS (09:50-10:30)</option>
           <option value="3">3. DERS (10:40-11:20)</option>
    <option value="4">4. DERS (11:30-12:10)</option>
    <option value="5">5. DERS (13:00-13:40)</option>
 <option value="6">6. DERS (13:50-14:30)</option>
   <option value="7">7. DERS (14:40-15:20)</option>
       <option value="8">8. DERS (15:30-16:10)</option>
    </select>
            </div>
          </div>
  </div>
      </div>

 <!-- 5. ADIM: DETAYLAR -->
      <div class="card mb-4" id="detayCard" style="display:none;">
      <div class="card-header bg-secondary text-white">
   <h5><i class="bi bi-5-circle"></i> Ek Bilgiler</h5>
    </div>
 <div class="card-body">
   <div class="row g-3">
     <div class="col-md-6">
    <label class="form-label"><strong>Telafi Nedeni</strong> <span class="text-danger">*</span></label>
   <input type="text" name="telafiNedeni" class="form-control" 
        placeholder="Örn: Ýzin, Hastalýk, Görev..." required />
   </div>
    <div class="col-md-6">
   <label class="form-label"><strong>Açýklama</strong></label>
        <textarea name="aciklama" class="form-control" rows="3" placeholder="Ek açýklama (opsiyonel)"></textarea>
    </div>
              </div>
      </div>
         </div>

     <div class="d-grid gap-2 d-md-flex justify-content-md-end">
              <a asp-action="Index" class="btn btn-secondary">
       <i class="bi bi-x-circle"></i> Ýptal
       </a>
      <button type="submit" class="btn btn-success btn-lg">
            <i class="bi bi-save"></i> Telafi Ekle
                </button>
       </div>
     </form>
   </div>
</div>
</div>

@section Scripts {
<script>
        let fakulteId = 0;
     let secilenDersId = 0;
  let secilenHocaId = 0;

        // FAKÜLTE SEÇÝMÝ
   $('#fakulteSelect').change(function () {
   fakulteId = $(this).val();
            if (fakulteId) {
    $('#dersHocaCard').show();
  $('#dersInput, #hocaInput').val('');
 $('#dersId, #hocaId').val('');
      $('#kisimCard, #telafiSaatCard, #detayCard').hide();
     }
   });

    // DERS AUTOCOMPLETE
  $('#dersInput').on('input', function () {
   let term = $(this).val();
   if (term.length < 2) {
        $('#dersOneri').empty();
     return;
      }

     $.ajax({
    url: '@Url.Action("SearchDersler", "DersProgrami")',
   data: { term: term },
 success: function (data) {
     let html = '';
    data.forEach(d => {
  html += `<a href="#" class="list-group-item list-group-item-action" onclick="dersSecildi('${d.dersAdi}', ${d.id}); return false;">${d.dersAdi}</a>`;
      });
        $('#dersOneri').html(html);
   }
   });
      });

  function dersSecildi(ad, id) {
         $('#dersInput').val(ad);
     $('#dersId').val(id);
  secilenDersId = id;
    $('#dersOneri').empty();
  $('#kisimCard').show();
}

  // HOCA AUTOCOMPLETE
   $('#hocaInput').on('input', function () {
 let term = $(this).val();
 if (term.length < 2 || !fakulteId || !secilenDersId) {
   $('#hocaOneri').empty();
          return;
    }

 $.ajax({
       url: '@Url.Action("SearchHocalar", "DersProgrami")',
  data: { fakulteId: fakulteId, term: term, dersId: secilenDersId },
   success: function (data) {
    let html = '';
   data.forEach(h => {
        html += `<a href="#" class="list-group-item list-group-item-action" onclick="hocaSecildi('${h.adSoyad}', ${h.id}); return false;">${h.rutbe} ${h.adSoyad}</a>`;
    });
   $('#hocaOneri').html(html);
     }
    });
      });

  function hocaSecildi(ad, id) {
       $('#hocaInput').val(ad);
  $('#hocaId').val(id);
     secilenHocaId = id;
   $('#hocaOneri').empty();
        }

 // DERS SAATLERÝNÝ GETÝR
 $('#saatleriGetirBtn').click(function () {
  let kisimlar = $('#kisimInput').val().trim();

      if (!fakulteId || !secilenHocaId || !kisimlar) {
    alert('Lütfen tüm alanlarý doldurun!');
    return;
        }

      // Ýlk kýsmý al (1-2-3 ise 1'i al)
       let kisimNo = kisimlar.split('-')[0].trim();

      $.ajax({
     url: '@Url.Action("GetDersSaatleri", "TelafiDers")',
    data: {
   fakulteId: fakulteId,
        hocaId: secilenHocaId,
         kisimNo: parseInt(kisimNo)
        },
      success: function (data) {
  if (data.length === 0) {
  alert('Bu hoca için ders saati bulunamadý!');
     return;
        }

    // Tüm günleri göster
   let html = '';
  data.forEach(grup => {
 let saatStr = grup.saatler.join('-');
       html += `<button type="button" class="btn btn-outline-primary saatBtn" data-gun="${grup.gun}" data-saat="${grup.saatler[0]}">
        ${grup.gun} - ${saatStr}. DERSLER
    </button>`;
     });

    $('#saatListesi').html(html);
  $('#saatlerDiv').show();
    $('#telafiSaatCard, #detayCard').show();

         // Saat butonlarýna týklama
     $('.saatBtn').click(function () {
 $('.saatBtn').removeClass('active');
    $(this).addClass('active');
           $('#normalGunInput').val($(this).data('gun'));
     $('#normalSaatInput').val($(this).data('saat'));
         });
       }
        });
        });
    </script>
}
